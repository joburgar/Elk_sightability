---
title: "Elk Sightability Analysis (2016 - 2022)"
author: "Tristen Brush"
date: "05/05/2022"
output: html_document
---
# Background information
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("SightabilityModel")
library(tidyverse)
library(readxl)
library(rjags)
list.of.packages <- c("tidyverse", "lubridate","chron","bcdata", "bcmaps","sf", "rgdal", "readxl", "Cairo", "rjags","coda",
                      "OpenStreetMap", "ggmap", "SightabilityModel","truncnorm", "doParallel", "nimble", "scrbook", "xtable")
# Check you have them and load them
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)
```

```{r moose example, eval=FALSE, include=FALSE}
data("obs.m")
data("exp.m")
data("sampinfo.m")

```

Stratum = EPU (BY YEAR, SAME EPU HAS DIFFERENT STRATUM # IN EACH YEAR)

Subunit = EPU

Nh = max area surveyed in 1 year

nh = area surveyed in year 

experimental surveys: surveys w/ telemetry searches (only non-incidental observations)
  Observed = 1 if collared animal seen
  Observed = 0 if collared animal searched for
  
operational surveys: inventory surveys (only non-telemetry observations)

List of EPUs:

```{r import data, echo=FALSE}
dat.2016 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2016 Survey Data", range = "A2:K78") 

dat.2017 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2017 Survey Data", range = "A1:K83") 

dat.2018 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2018 Survey Data", range = "A1:K76") 

dat.2019 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2019 Survey Data", range = "A1:K96")

dat.2020 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2020 Survey Data", range = "A1:K93")

dat.2021 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2021 Survey Data", range = "A1:O136", 
    col_types = c("numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "skip", "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "text", 
        "text"))
dat.2022 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2022 Survey Data", range = "A1:P102", 
    col_types = c("numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "skip", "numeric", "numeric", "numeric", 
        "skip", "text", "text", "numeric", 
        "text", "text"))
EPU.areas <- read_csv("data/Effort/EPU_areas.csv", 
    col_types = cols(OID = col_skip(), Shape_Leng = col_skip()))

EPU.list <- as.character(EPU.areas$Unit)
print(EPU.list)

```

```{r sampinfo 1, include=FALSE}
area.2016 <- read_csv("data/Effort/areas_2016.csv")
eff.2016 <- area.2016 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2016)

area.2017 <- read_csv("data/Effort/areas_2017.csv") %>%
  # get rid of surveys that weren't counted in total
  filter(begin != "2017/03/14 21:06:36.055" | Unit!="Clowhom") %>%
  filter((begin != "2017/03/20 15:16:10.196" & begin != "2017/03/30 15:19:37.056") | Unit!="Stave") %>%
  filter(begin != "2017/03/27 15:12:24.072" | Unit!="Rainy-Gray") %>%
  filter(begin != "2017/03/30 15:19:37.056" | Unit!="Pitt")
eff.2017 <- area.2017 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2017)

area.2018 <- read_csv("data/Effort/areas_2018.csv") %>%
    filter(begin == "2017/03/30 15:19:37.056" | Unit!="Pitt")
eff.2018 <- area.2018 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2018)

area.2019 <- read_csv("data/Effort/areas_2019.csv")
eff.2019 <- area.2019 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2019)

area.2020 <- read_csv("data/Effort/areas_2020.csv") %>%
  filter(Unit != "Skwawka" | begin != "2020/03/24 19:15:10.996") %>%
  filter(Unit != "Sechelt")
eff.2020 <- area.2020 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2020)

area.2021 <- read_csv("data/Effort/areas_2021.csv")
eff.2021 <- area.2021 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2021)

```

```{r exp, include=FALSE}
# clean survey types and filter out incidental observations
# 2 options:
## 1. 1 for spotting collared elk, 0 for searching for collar
## 2. 1 for spotting any elk (collared or not), 0 for searching for collar

exp.tmp <- bind_rows(dat.2021, dat.2022) %>%
  mutate(
    subunit = EPU,
    total = `Elk Obs.`,
    survey.type = `Survey type`,
    voc = `% cover`,
    .keep = "unused"
    ) %>%
  mutate(
    survey.type = case_when(
      grepl("incidental", survey.type, ignore.case = TRUE) ~ "Incidental",
      grepl("telemetry", survey.type, ignore.case = TRUE) ~ "Telemetry",
      grepl("transect", survey.type, ignore.case = TRUE) ~ "Inventory",
      grepl("inventory", survey.type, ignore.case = TRUE) ~ "Inventory",
      TRUE ~ "Other"
      )
    ) %>%
  filter(survey.type == "Telemetry" | survey.type == "Inventory")


# Option 1
exp.tmp <- exp.tmp %>%
  mutate(collar =
    case_when(
      grepl("no collar", `Notes:`, ignore.case = TRUE) ~ "No Collar",
      grepl("dart", `Notes:`, ignore.case = TRUE) ~ "No Collar",
      str_detect(`Notes:`, "15\\d.\\d\\d\\d") ~ as.character(
        str_extract_all(`Notes:`, "15\\d.\\d\\d\\d"), sep=", "),
      str_detect(`Notes:`, "\\d\\d\\d\\d\\d") ~ as.character(
        str_extract_all(`Notes:`, "\\d\\d\\d\\d\\d"), sep=", "),
      str_detect(`Notes:`, "2 yellow collar") ~ "Yellow, Yellow",      
      grepl("yellow collar", `Notes:`, ignore.case = TRUE) ~ "Yellow",
      grepl("Telemetry", `survey.type`) ~ "0",
      TRUE ~ "No Collar"
    )
  ) %>%
  filter(collar != "No Collar") %>%
  arrange(collar)

# duplicate observations with 2 collars, then clean
exp.tmp <- rbind(exp.tmp, exp.tmp[rep(c(44:48, 56:57), 1),])

exp1 <- exp.tmp %>%
  transmute(
    year = as.integer(Year),
    observed = as.integer(if_else(survey.type=="Inventory", 1, 0)),
    voc = as.integer(voc*100),
    grpsize = as.integer(total),
    habitat = Habitat,
    activity = Activity
    )

# Option 2
exp2 <- exp.tmp %>%
  transmute(
    year = as.integer(Year),
    observed = as.integer(if_else(survey.type=="Transect", 1, 0)),
    voc = as.integer(voc*100),
    grpsize = as.integer(total),
    habitat = Habitat,
    activity = Activity
  )
```

```{r obs, include=FALSE}
# 2016
# deal w/ NAs and raghorn observations, then clean
dat.2016 <- dat.2016 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Raghorn = if_else(is.na(Raghorn), 0, Raghorn),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2016 <- dat.2016 %>%
  mutate(Bull = Bull+Raghorn) %>%
  select(!Raghorn) %>%
  transmute(
    year = 2016,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
# Get rid of incidentals/observations not counted in total
obs.2016 <- obs.2016 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2017
dat.2017 <- dat.2017 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Raghorn = if_else(is.na(Raghorn), 0, Raghorn),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2017 <- dat.2017 %>%
  mutate(Bull = Bull+Raghorn) %>%
  select(!Raghorn) %>%
  transmute(
    year = 2017,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2017 <- obs.2017 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2018
# unique() tells us there are no values for Raghorn or unclassified -> get rid of raghorn and make unclass = 0
dat.2018 <- dat.2018 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    `Unclass.` = 0
  )
obs.2018 <- dat.2018 %>%
  select(!Raghorn) %>%
  transmute(
    year = 2018,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2018 <- obs.2018 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2019
# unique() tells us no raghorn values exist -> just delete
dat.2019 <- dat.2019 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2019 <- dat.2019 %>%
  select(!Raghorn) %>%
  transmute(
    year = 2019,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2019 <- obs.2019 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2020
# same as 2018
dat.2020 <- dat.2020 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = 0
  )
obs.2020 <- dat.2020 %>%
  select(!Raghorn) %>%
  transmute(
    year = 2020,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2020 <- obs.2020 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2021
dat.2021 <- dat.2021 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2021 <- dat.2021 %>%
  transmute(
    year = 2021,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    voc = `% cover`*100,
    habitat = Habitat,
    activity = Activity,
    notes = `Notes:`
  )
obs.2021 <- obs.2021 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# bind together
obs.all <- bind_rows(obs.2016, obs.2017, obs.2018, obs.2019, obs.2020, obs.2021)

# ensure EPU names match
setdiff(obs.all$subunit, EPU.list) # 29 names don't match EPU list names, fix below
obs.all <- obs.all %>%
  mutate(subunit = case_when(
    grepl("Rainy", subunit, ignore.case = TRUE) ~ "Rainy-Gray",
    grepl("Narrows", subunit, ignore.case = TRUE) ~ "Tzoonie-Narrows",
    grepl("Deserted", subunit, ignore.case = TRUE) ~ "Deserted-Stakawus",
    grepl("Chehalis", subunit, ignore.case = TRUE) ~ "Chehalis",
    grepl("Sechelt", subunit, ignore.case = TRUE) ~ "Sechelt Peninsula",
    grepl("Homathco", subunit, ignore.case = TRUE) ~ "Homathko",
    grepl("Haslam", subunit, ignore.case = TRUE) ~ "Haslam",
    grepl("Dani", subunit, ignore.case = TRUE) ~ "Powell-Daniels",
    grepl("Quatum", subunit, ignore.case = TRUE) ~ "Quatam",
    grepl("Lillooet", subunit, ignore.case = TRUE) ~ "Lower Lillooet",
    grepl("Vancouver", subunit, ignore.case = TRUE) ~ "Vancouver",
    grepl("Squamish", subunit, ignore.case = TRUE) ~ "Squamish",
    grepl("Indian", subunit, ignore.case = TRUE) ~ "Indian",
    grepl("Stave", subunit, ignore.case = TRUE) ~ "Stave",
    grepl("Theo", subunit, ignore.case = TRUE) ~ "Theo",
    grepl("Mcnab", subunit, ignore.case = TRUE) ~ "McNab",
    grepl("Bear", subunit, ignore.case = TRUE) ~ "Bear",
    TRUE ~ subunit
  ))

# make sure all EPU names match
setdiff(obs.all$subunit, EPU.list) #If returns "character(0)", all names match

# Get rid of incidental observations outside each year's surveyed EPUs
obs.all <- obs.all %>%
  filter(total > 0) %>%
  mutate(subunit = if_else(
    year == 2016 & subunit %in% eff.2016$Unit, subunit,
    if_else(
    year == 2017 & subunit %in% eff.2017$Unit, subunit,
    if_else(
    year == 2018 & subunit %in% eff.2018$Unit, subunit,
    if_else(
    year == 2019 & subunit %in% eff.2019$Unit, subunit,
    if_else(
    year == 2020 & subunit %in% eff.2020$Unit, subunit,
    if_else(
    year == 2021 & subunit %in% eff.2021$Unit, subunit,
    "X"))))))) %>%
  filter(subunit != "X")
```

EPU strata guide:

```{r Stratum field, echo=FALSE}
# Create stratum ID field
## 1. Break obs.all into each year

tmp <- obs.all %>%
  filter(year==2016)
eff.2016 <- semi_join(eff.2016, tmp, by=c("Unit"="subunit", "year"))
eff.2016 <- eff.2016 %>%
  mutate(ID = as.integer(row.names(eff.2016)))
tmp.2016 <- left_join(tmp, eff.2016, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2017)
eff.2017 <- semi_join(eff.2017, tmp, by=c("Unit"="subunit", "year"))
eff.2017 <- eff.2017 %>%
  mutate(ID = as.integer(row.names(eff.2017)))
tmp.2017 <- left_join(tmp, eff.2017, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2018)
eff.2018 <- semi_join(eff.2018, tmp, by=c("Unit"="subunit", "year"))
eff.2018 <- eff.2018 %>%
  mutate(ID = as.integer(row.names(eff.2018)))
tmp.2018 <- left_join(tmp, eff.2018, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2019)
eff.2019 <- semi_join(eff.2019, tmp, by=c("Unit"="subunit", "year"))
eff.2019 <- eff.2019 %>%
  mutate(ID = as.integer(row.names(eff.2019)))
tmp.2019 <- left_join(tmp, eff.2019, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2020)
eff.2020 <- semi_join(eff.2020, tmp, by=c("Unit"="subunit", "year"))
eff.2020 <- eff.2020 %>%
  mutate(ID = as.integer(row.names(eff.2020)))
tmp.2020 <- left_join(tmp, eff.2020, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2021)
eff.2021 <- semi_join(eff.2021, tmp, by=c("Unit"="subunit", "year"))
eff.2021 <- eff.2021 %>%
  mutate(ID = as.integer(row.names(eff.2021)))
tmp.2021 <- left_join(tmp, eff.2021, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

## 2. Join back together
obs <- bind_rows(tmp.2016, tmp.2017, tmp.2018, tmp.2019, tmp.2020, tmp.2021)
paste0(2016)
eff.2016 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
paste0(2017)
eff.2017 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
paste0(2018)
eff.2018 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
paste0(2019)
eff.2019 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
paste0(2020)
eff.2020 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
paste0(2021)
eff.2021 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
```

```{r finish obs, include=FALSE}
# Make all numeric fields integers
obs <- obs %>%
  mutate(year = as.integer(year),
         stratum = as.integer(stratum),
         total = as.integer(total),
         cows = as.integer(cows),
         calves = as.integer(calves),
         spikes = as.integer(spikes),
         bulls = as.integer(bulls),
         unclass = as.integer(unclass),
         voc = as.integer(voc),
         grpsize = as.integer(grpsize))

# make sure totals = sum of cows, calves, etc
obs %>%
  filter(obs$total != (obs$cows+obs$calves+obs$spikes+obs$bulls+obs$unclass)) %>%
  view()
# If records show up, use code below to add unclassified individuals & re-check
obs <- obs %>%
  mutate(
    unclass = if_else(
      total == (cows+calves+spikes+bulls+unclass), unclass,
      total-((cows+calves+spikes+bulls)))
  )
obs %>%
  filter(obs$total != (obs$cows+obs$calves+obs$spikes+obs$bulls+obs$unclass)) %>%
  view() # all good now
```

```{r sampinfo 2, warning=FALSE, include=FALSE}
# Get rid of eff records of surveyed areas that had no observations

eff <- bind_rows(eff.2016, eff.2017, eff.2018, eff.2019, eff.2020, eff.2021)
eff.max <- eff %>%
  group_by(Unit) %>%
  slice_max(area_surveyed_km) %>%
  mutate(Nh = area_surveyed_km) %>%
  select(Unit, Nh)

sampinfo <- left_join(eff, eff.max, by="Unit")

sampinfo <- sampinfo %>%
  mutate(stratum = as.integer(ID), Nh = as.integer(Nh), 
         nh = as.integer(area_surveyed_km), year = as.integer(year)) %>%
  select(year, stratum, Nh, nh)

# Make sure all stratum listed in obs are listed in sampinfo for each year
setdiff(sampinfo$stratum[sampinfo$year==2016], unique(obs$stratum[obs$year==2016]))
setdiff(sampinfo$stratum[sampinfo$year==2017], unique(obs$stratum[obs$year==2017]))
setdiff(sampinfo$stratum[sampinfo$year==2018], unique(obs$stratum[obs$year==2018]))
setdiff(sampinfo$stratum[sampinfo$year==2019], unique(obs$stratum[obs$year==2019]))
setdiff(sampinfo$stratum[sampinfo$year==2020], unique(obs$stratum[obs$year==2020]))
setdiff(sampinfo$stratum[sampinfo$year==2021], unique(obs$stratum[obs$year==2021]))
```

# mHT Analysis

## 2016

```{r 2016 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}
# 2016
# All data
est.2016 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2016), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2016))  
results.all.2016 <-print(est.2016)

# By strata
tau.hats <- matrix(NA, length(eff.2016$ID), 7)
rownames(tau.hats) <- c(eff.2016$Unit)
for(i in 1:length(eff.2016$ID)){
  tempsamp <- sampinfo[sampinfo$year==2016 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2016 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2016 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2016 <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())
```

## 2017

```{r 2017 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2017
# All data
est.2017 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2017), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2017))  
results.all.2017 <-print(est.2017)

# By strata
tau.hats <- matrix(NA, length(eff.2017$ID), 7)
rownames(tau.hats) <- c(eff.2017$Unit)
for(i in 1:length(eff.2017$ID)){
  tempsamp <- sampinfo[sampinfo$year==2017 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2017 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2017 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2017 <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())
```

## 2018

```{r 2018 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2018
# All data
est.2018 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2018), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2018))  
results.all.2018 <-print(est.2018)

# By strata
tau.hats <- matrix(NA, length(eff.2018$ID), 7)
rownames(tau.hats) <- c(eff.2018$Unit)
for(i in 1:length(eff.2018$ID)){
  tempsamp <- sampinfo[sampinfo$year==2018 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2018 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2018 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2018 <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())
```

## 2019

```{r 2019 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2019
# Keep in mind had to remove observations b/c lost effort data for Mar 29
# All data
est.2019 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2019), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2019))  
results.all.2019 <-print(est.2019)

# By strata
tau.hats <- matrix(NA, length(eff.2019$ID), 7)
rownames(tau.hats) <- c(eff.2019$Unit)
for(i in 1:length(eff.2019$ID)){
  tempsamp <- sampinfo[sampinfo$year==2019 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2019 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2019 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2019 <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())
```

## 2020

```{r 2020 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2020
# All data
est.2020 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2020), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2020))  
results.all.2020 <-print(est.2020)

# By strata
tau.hats <- matrix(NA, length(eff.2020$ID), 7)
rownames(tau.hats) <- c(eff.2020$Unit)
for(i in 1:length(eff.2020$ID)){
  tempsamp <- sampinfo[sampinfo$year==2020 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2020 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2020 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2020 <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())
```

## 2021

```{r 2021 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2021
# All data
est.2021 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2021), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2021))  
results.all.2021 <- print(est.2021)
summary(est.2021)

# By strata
tau.hats <- matrix(NA, length(eff.2021$ID), 7)
rownames(tau.hats) <- c(eff.2021$Unit)
for(i in 1:length(eff.2021$ID)){
  tempsamp <- sampinfo[sampinfo$year==2021 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2021 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2021 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2021 <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())
```

### With VOC variable:

```{r 2021 voc analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2021 w/ voc (remove any NAs in voc)
obs.voc <- obs %>%
  filter(!is.na(voc))
# All data
est.2021.voc <- Sight.Est(observed ~ voc, odat = subset(obs.voc,year == 2021), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2021))  
results.all.2021.voc <-print(est.2021.voc)

# By strata
tau.hats <- matrix(NA, length(eff.2021$ID), 7)
rownames(tau.hats) <- c(eff.2021$Unit)
for(i in 1:length(eff.2021$ID)){
  tempsamp <- sampinfo[sampinfo$year==2021 & sampinfo$stratum==i, ]
  tempobs <- obs.voc[obs.voc$year == 2021 & obs.voc$stratum == i, ]
  temp <- Sight.Est(observed ~ voc, odat = tempobs, sdat = exp1, tempsamp)
  temp.summary <- summary(temp)
  tau.hats[i,1:5] <- temp$est
  tau.hats[i,6] <- as.numeric(gsub(",","",temp.summary$lcl))
  tau.hats[i,7] <- as.numeric(gsub(",","",temp.summary$ucl))
}
colnames(tau.hats) <- c(names(temp$est), "LCL", "UCL")
tau.hats<-round(tau.hats, 0)
results.strat.2021.voc <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
results.strat.2021.voc <- as.data.frame(tau.hats) %>%
  select(tau.hat, LCL:UCL, everything())

```

## Summary plots

### Sechelt Peninsula
```{r echo=FALSE}
tau.Sechelt <- matrix(NA,6,3)
i<- 1
for(i in 1:3 ){
  tau.Sechelt[1,i] <- results.strat.2016["Sechelt Peninsula", i]
  tau.Sechelt[2,i] <- results.strat.2017["Sechelt Peninsula", i]
  tau.Sechelt[3,i] <- results.strat.2018["Sechelt Peninsula", i]
  tau.Sechelt[4,i] <- results.strat.2019["Sechelt Peninsula", i]
  tau.Sechelt[5,i] <- results.strat.2020["Sechelt Peninsula", i]
  tau.Sechelt[6,i] <- results.strat.2021["Sechelt Peninsula", i]
}
rownames(tau.Sechelt) <- 2016:2021
colnames(tau.Sechelt) <- c("Estimate","LCL","UCL")
tau.Sechelt <- as.data.frame(tau.Sechelt)

Sechelt_plot = ggplot(tau.Sechelt, aes(x = row.names(tau.Sechelt), y=Estimate))+
  geom_point(colour="black", shape=15, size=3)+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
       panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  xlab(expression(paste("Year"))) +
  ylab(expression(paste("Population Estimate ± 95 CI"))) +
  geom_linerange(aes(row.names(tau.Sechelt), ymin = LCL, ymax = UCL)) +
  theme(axis.title.x= element_text(size=14)) +
  theme(axis.text.y = element_text(size=14))
Sechelt_plot

```

# Bayesian Analysis

```{r sightabiliy data}
# 1.  sight_dat.csv = Sightability survey data:  124 records
# x = visual obstrcution measurements associated with the test trial data used to develop the     sightability model
# z = detection indicator (1 if the group was observed, 0 otherwise)

sight.dat <- exp.tmp %>%
  mutate(x.tilde = voc,
         z.tilde = if_else(survey.type=="Telemetry", 0, 1), .keep="none")
glimpse(sight.dat) # check - looks the same as Fieberg's sight_dat csv
```

```{r operational data}
#  2. oper_dat.csv:  Operational survey data:  4380 records
# (includes observed and augmented data for the annual surveys in  2006 and 2007 combined).
# Augmented data records have NA (missing) for x, y, q.
# x = visual obstruction measurements
# ym1 = y-1, where y = observed group size
# h = stratum identifier (1, 2, 3 correspond to low, medium and high density strata)
# q = indicator variable that represents whether the group belongs to the study population (equal to 1 for all observed groups and NA for all augmented groups).
# z = detection indicator (equal to 1 if the group was observed during the operational survey and 0 otherwise)
# subunits = unique plot identifier (for all sampled plots).
# yr = year of observation (1 = 2006, 2= 2007)

# non-augmented data
# need average voc of each subunit
dat.voc <- bind_rows(dat.2021, dat.2022) %>%
  mutate(
    subunit = EPU,
    total = `Elk Obs.`,
    survey.type = `Survey type`,
    voc = `% cover`,
    .keep = "unused"
    )

setdiff(dat.voc$subunit, EPU.list) # 12 names don't match EPU list names, fix below

dat.voc <- dat.voc %>%
  mutate(subunit = case_when(
    grepl("Rainy", subunit, ignore.case = TRUE) ~ "Rainy-Gray",
    grepl("Narrows", subunit, ignore.case = TRUE) ~ "Tzoonie-Narrows",
    grepl("Deserted", subunit, ignore.case = TRUE) ~ "Deserted-Stakawus",
    grepl("Sechelt", subunit, ignore.case = TRUE) ~ "Sechelt Peninsula",
    grepl("Homathco", subunit, ignore.case = TRUE) ~ "Homathko",
    grepl("Haslam", subunit, ignore.case = TRUE) ~ "Haslam",
    grepl("Dani", subunit, ignore.case = TRUE) ~ "Powell-Daniels",
    grepl("Quatum", subunit, ignore.case = TRUE) ~ "Quatam",
    grepl("Vancouver", subunit, ignore.case = TRUE) ~ "Vancouver",
    grepl("Mcnab", subunit, ignore.case = TRUE) ~ "McNab",
    grepl("southgate", subunit, ignore.case = TRUE) ~ "Southgate",
    TRUE ~ subunit
  )) %>%
  # now clean to remove telemetry obs
  mutate(
    survey.type = case_when(
      grepl("incidental", survey.type, ignore.case = TRUE) ~ "Incidental",
      grepl("telemetry", survey.type, ignore.case = TRUE) ~ "Telemetry",
      grepl("transect", survey.type, ignore.case = TRUE) ~ "Inventory",
      grepl("inventory", survey.type, ignore.case = TRUE) ~ "Inventory",
      TRUE ~ "Other"
      )
    ) %>%
  filter(survey.type != "Telemetry") %>%
  # get average voc
  select(subunit, voc) %>%
  group_by(subunit) %>%
  summarize(avg_voc = round(mean(voc, na.rm=T), digits = 2))

 oper.dat <-  left_join(obs, dat.voc, by="subunit") %>%
   mutate(voc = if_else(is.na(voc), avg_voc, as.double(voc*.01)),
          q = 1,
          z = 1,
          ym1 = grpsize - 1,
          yr = as.double(year),
          h = as.double(stratum)) %>%
   select(x = voc, ym1, h, q, z, yr, subunits = subunit)

 # augmented data
 # need to determine max m of each h
m.est <- obs %>%
  group_by(subunit, year, stratum) %>%
  summarize(m = n())
m.max <- m.est %>%
  group_by(subunit) %>%
  summarize(m.max = max(m))
b.h <- m.max %>%
  mutate(b.h = 10*m.max)
  oper.dat.aug <-  full_join(m.est, b.h, by="subunit") %>%
    mutate(B_minus_m = b.h-m)
  oper.dat.aug <- oper.dat.aug[rep(1:nrow(oper.dat.aug), oper.dat.aug$B_minus_m),] %>%
    mutate(x = NA, ym1 = NA, h = stratum, q = NA, z = 0, yr = year, subunits = subunit, .keep="none")

  oper.dat <- rbind(oper.dat, oper.dat.aug[,3:9])

oper.dat # check - looks the same as Fieberg's oper_dat csv
```
```{r plot data}
# 3.  plot_dat.csv:  Plot-level information data: 77 records (one for each of the plots sampled in either 2006 or 2007)
# h.plots = stratum to which the plot belonged (1, 2, 3 correspond to low, medium and high density strata)
# yr.plots = year the plot was sampled (1 = 2006, 2= 2007)
plot.dat <- eff %>%
  select(h.plots = ID, yr.plots = year)
```

```{r scalar data}
# 4.  scalar_dat.csv:  Scalars:
#   R = number of sightability trials (64)
# 
#   Ngroups = number of observed and augmented groups for the 2006 and 2007 annual operational surveys (7290)
# 
#   Nsubunits.yr = total number of plots sampled in 2006 and 2007 combined = 81 
# 
#   ny1 = number of groups associated with the annual survey in 2006 (year 1) = 960

scalar.dat <- as.data.frame(matrix(NA, 1, 4))
colnames(scalar.dat) <- c("R", "Ngroups", "Nsubunits.yr", "ny1")
scalar.dat <- scalar.dat %>%
  mutate(R = nrow(sight.dat),
         Ngroups = nrow(oper.dat),
         Nsubunits.yr = nrow(plot.dat),
         ny1 = nrow(oper.dat[oper.dat$yr==2016,])
  )
```

```{r run model}
# specify initial values
inits <-  function() list(bo=runif(1), bvoc=runif(1))

# Parameters monitored
params <- c("tau.samp1", "tau.samp2", "tau.samp3", "tau.samp4", "tau.samp5", "tau.samp6", "bo", "bvoc")

# MCMC settings
ni <- 40000 # build to 40000
nt <- 2     # 50% thinning rate (discard every 2nd iteration)
nb <- 20000 # build to 20000
nc <- 3

# Bundle data
bundle.data <- list(x.tilde=sight.dat$x.tilde, z.tilde=sight.dat$z.tilde, #sight.dat
                    x=oper.dat$x, ym1=oper.dat$ym1, h=oper.dat$h, q=oper.dat$q, z=oper.dat$z, yr=oper.dat$yr, subunits=oper.dat$subunits, # oper_dat
                    h.plots=plot.dat$h.plots, yr.plots=plot.dat$yr.plots, # plot_dat
                    R=scalar.dat$R, Ngroups=scalar.dat$Ngroups, Nsubunits.yr=scalar.dat$Nsubunits.yr, ny1=scalar.dat$ny1) # scalar_dat

# Run model
jags_output <- jags(bundle.data, inits, params, "beta_binom_model_elksim.txt",
                       n.chains=nc, n.thin=nt, n.iter=ni, n.burnin=nb,
                       parallel=TRUE, n.cores=1)
jags_output

save("jags_output",file="jags_output.RData") #

summary(jags_output) # only the first 18 models ran
```




