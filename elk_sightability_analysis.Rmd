---
title: "Elk Sightability Analysis (2016 - 2021)"
author: "Tristen Brush"
date: "05/05/2022"
output: html_document
---
# Background information
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("SightabilityModel")
library(tidyverse)
library(readxl)
```

```{r moose example, eval=FALSE, include=FALSE}
data("obs.m")
data("exp.m")
data("sampinfo.m")

```

Stratum = EPU (BY YEAR, SAME EPU HAS DIFFERENT STRATUM # IN EACH YEAR)

Subunit = EPU

Nh = max area surveyed in 1 year

nh = area surveyed in year 

experimental surveys: surveys w/ telemetry searches (only non-incidental observations)
  Observed = 1 if collared animal seen
  Observed = 0 if collared animal searched for
  
operational surveys: inventory surveys (only non-telemetry observations)

List of EPUs:

```{r import data, include=FALSE}
dat.2016 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2016 Survey Data", range = "A2:K78") 

dat.2017 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2017 Survey Data", range = "A1:K83") 

dat.2018 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2018 Survey Data", range = "A1:K76") 

dat.2019 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2019 Survey Data", range = "A1:K96")

dat.2020 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2020 Survey Data", range = "A1:K93")

dat.2021 <- read_excel("data/SurveyData_ SPRING_2022.xls", 
    sheet = "2021 Survey Data", range = "A1:O136", 
    col_types = c("numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "skip", "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "text", 
        "text"))
EPU.areas <- read_csv("data/Effort/EPU_areas.csv", 
    col_types = cols(OID = col_skip(), Shape_Leng = col_skip()))

EPU.list <- as.character(EPU.areas$Unit)
print(EPU.list)

```

```{r sampinfo 1, include=FALSE}
area.2016 <- read_csv("data/Effort/areas_2016.csv")
eff.2016 <- area.2016 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2016)

area.2017 <- read_csv("data/Effort/areas_2017.csv") %>%
  # get rid of surveys that weren't counted in total
  filter(begin != "2017/03/14 21:06:36.055" | Unit!="Clowhom") %>%
  filter((begin != "2017/03/20 15:16:10.196" & begin != "2017/03/30 15:19:37.056") | Unit!="Stave") %>%
  filter(begin != "2017/03/27 15:12:24.072" | Unit!="Rainy-Gray") %>%
  filter(begin != "2017/03/30 15:19:37.056" | Unit!="Pitt")
eff.2017 <- area.2017 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2017)

area.2018 <- read_csv("data/Effort/areas_2018.csv") %>%
    filter(begin == "2017/03/30 15:19:37.056" | Unit!="Pitt")
eff.2018 <- area.2018 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2018)

area.2019 <- read_csv("data/Effort/areas_2019.csv")
eff.2019 <- area.2019 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2019)

area.2020 <- read_csv("data/Effort/areas_2020.csv") %>%
  filter(Unit != "Skwawka" | begin != "2020/03/24 19:15:10.996") %>%
  filter(Unit != "Sechelt")
eff.2020 <- area.2020 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2020)

area.2021 <- read_csv("data/Effort/areas_2021.csv")
eff.2021 <- area.2021 %>%
  group_by(Unit) %>%
  summarise(area_surveyed = sum(Shape_Area)) %>%
  mutate(area_surveyed_km = area_surveyed/1000000, year = 2021)

```

```{r exp, include=FALSE}
# clean survey types and filter out incidental observations
# 2 options:
## 1. 1 for spotting collared elk, 0 for searching for collar
## 2. 1 for spotting any elk (collared or not), 0 for searching for collar

exp.tmp <- dat.2021 %>%
  mutate(
    subunit = EPU,
    total = `Elk Obs.`,
    survey.type = `Survey type`,
    voc = `% cover`,
    .keep = "unused"
    ) %>%
  mutate(
    survey.type = case_when(
      grepl("incidental", survey.type, ignore.case = TRUE) ~ "Incidental",
      grepl("transect", survey.type, ignore.case = TRUE) ~ "Transect",
      grepl("telemetry", survey.type, ignore.case = TRUE) ~ "Telemetry"
      )
    ) %>%
  filter(survey.type != "Incidental")
#make sure transect and telemetry are the only values
unique(exp.tmp$survey.type)

# Option 1
exp1 <- exp.tmp %>%
  mutate(collar =
    case_when(
      grepl("no collar", `Notes:`, ignore.case = TRUE) ~ "No Collar",
      str_detect(`Notes:`, "15\\d.\\d\\d\\d") ~ as.character(
        str_extract_all(`Notes:`, "15\\d.\\d\\d\\d"), sep=", "),
      TRUE ~ "No Collar"
    )
  ) %>%
  filter(collar != "No Collar") %>%
  transmute(
    year = as.integer(Year),
    observed = as.integer(if_else(survey.type=="Transect", 1, 0)),
    voc = as.integer(voc*100),
    grpsize = as.integer(total),
    habitat = Habitat,
    activity = Activity
    )

# Option 2
exp2 <- exp.tmp %>%
  transmute(
    year = as.integer(Year),
    observed = as.integer(if_else(survey.type=="Transect", 1, 0)),
    voc = as.integer(voc*100),
    grpsize = as.integer(total),
    habitat = Habitat,
    activity = Activity
  )

```

```{r obs, include=FALSE}
# 2016
# deal w/ NAs and raghorn observations, then clean
dat.2016 <- dat.2016 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Raghorn = if_else(is.na(Raghorn), 0, Raghorn),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2016 <- dat.2016 %>%
  mutate(Bull = Bull+Raghorn) %>%
  select(!Raghorn) %>%
  transmute(
    year = 2016,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
# Get rid of incidentals/observations not counted in total
obs.2016 <- obs.2016 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2017
dat.2017 <- dat.2017 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Raghorn = if_else(is.na(Raghorn), 0, Raghorn),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2017 <- dat.2017 %>%
  mutate(Bull = Bull+Raghorn) %>%
  select(!Raghorn) %>%
  transmute(
    year = 2017,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2017 <- obs.2017 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2018
# unique() tells us there are no values for Raghorn or unclassified -> get rid of raghorn and make unclass = 0
dat.2018 <- dat.2018 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    `Unclass.` = 0
  )
obs.2018 <- dat.2018 %>%
  select(!Raghorn) %>%
  transmute(
    year = 2018,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2018 <- obs.2018 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2019
# unique() tells us no raghorn values exist -> just delete
dat.2019 <- dat.2019 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2019 <- dat.2019 %>%
  select(!Raghorn) %>%
  transmute(
    year = 2019,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2019 <- obs.2019 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2020
# same as 2018
dat.2020 <- dat.2020 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = 0
  )
obs.2020 <- dat.2020 %>%
  select(!Raghorn) %>%
  transmute(
    year = 2020,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    notes = `Notes:`
  )
obs.2020 <- obs.2020 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# 2021
dat.2021 <- dat.2021 %>%
  mutate(
    Cow = if_else(is.na(Cow), 0, Cow),
    Calf = if_else(is.na(Calf), 0, Calf),
    Spike = if_else(is.na(Spike), 0, Spike),
    Bull = if_else(is.na(Bull), 0, Bull),
    Unclass. = if_else(is.na(Unclass.), 0, Unclass.)
  )
obs.2021 <- dat.2021 %>%
  transmute(
    year = 2021,
    stratum = 0,
    subunit = EPU,
    total = if_else(is.na(`Elk Obs.`), 0, `Elk Obs.`),
    cows = Cow,
    calves = Calf,
    spikes = Spike,
    bulls = Bull,
    unclass = `Unclass.`,
    grpsize = `Elk Obs.`,
    voc = `% cover`*100,
    habitat = Habitat,
    activity = Activity,
    notes = `Notes:`
  )
obs.2021 <- obs.2021 %>%
  mutate(counted = case_when(
    grepl("re-flown", notes, ignore.case = TRUE) |
      grepl("not in total", notes, ignore.case = TRUE) |
      grepl("not counted", notes, ignore.case = TRUE) |
      grepl("no effort", notes, ignore.case = TRUE) |
      grepl("incidental", notes, ignore.case = TRUE) ~ "N",
    TRUE ~ "Y"
  )) %>%
  filter(counted=="Y")

# bind together
obs.all <- bind_rows(obs.2016, obs.2017, obs.2018, obs.2019, obs.2020, obs.2021)

# ensure EPU names match
setdiff(obs.all$subunit, EPU.list) # 29 names don't match EPU list names, fix below
obs.all <- obs.all %>%
  mutate(subunit = case_when(
    grepl("Rainy", subunit, ignore.case = TRUE) ~ "Rainy-Gray",
    grepl("Narrows", subunit, ignore.case = TRUE) ~ "Tzoonie-Narrows",
    grepl("Deserted", subunit, ignore.case = TRUE) ~ "Deserted-Stakawus",
    grepl("Chehalis", subunit, ignore.case = TRUE) ~ "Chehalis",
    grepl("Sechelt", subunit, ignore.case = TRUE) ~ "Sechelt Peninsula",
    grepl("Homathco", subunit, ignore.case = TRUE) ~ "Homathko",
    grepl("Haslam", subunit, ignore.case = TRUE) ~ "Haslam",
    grepl("Dani", subunit, ignore.case = TRUE) ~ "Powell-Daniels",
    grepl("Quatum", subunit, ignore.case = TRUE) ~ "Quatam",
    grepl("Lillooet", subunit, ignore.case = TRUE) ~ "Lower Lillooet",
    grepl("Vancouver", subunit, ignore.case = TRUE) ~ "Vancouver",
    grepl("Squamish", subunit, ignore.case = TRUE) ~ "Squamish",
    grepl("Indian", subunit, ignore.case = TRUE) ~ "Indian",
    grepl("Stave", subunit, ignore.case = TRUE) ~ "Stave",
    grepl("Theo", subunit, ignore.case = TRUE) ~ "Theo",
    grepl("Mcnab", subunit, ignore.case = TRUE) ~ "McNab",
    grepl("Bear", subunit, ignore.case = TRUE) ~ "Bear",
    TRUE ~ subunit
  ))

# make sure all EPU names match
setdiff(obs.all$subunit, EPU.list) #If returns "character(0)", all names match

# Get rid of incidental observations outside each year's surveyed EPUs
obs.all <- obs.all %>%
  filter(total > 0) %>%
  mutate(subunit = if_else(
    year == 2016 & subunit %in% eff.2016$Unit, subunit,
    if_else(
    year == 2017 & subunit %in% eff.2017$Unit, subunit,
    if_else(
    year == 2018 & subunit %in% eff.2018$Unit, subunit,
    if_else(
    year == 2019 & subunit %in% eff.2019$Unit, subunit,
    if_else(
    year == 2020 & subunit %in% eff.2020$Unit, subunit,
    if_else(
    year == 2021 & subunit %in% eff.2021$Unit, subunit,
    "X"))))))) %>%
  filter(subunit != "X")
```

EPU strata guide:

```{r Stratum field, include=FALSE}
# Create stratum ID field
## 1. Break obs.all into each year

tmp <- obs.all %>%
  filter(year==2016)
eff.2016 <- semi_join(eff.2016, tmp, by=c("Unit"="subunit", "year"))
eff.2016 <- eff.2016 %>%
  mutate(ID = as.integer(row.names(eff.2016)))
tmp.2016 <- left_join(tmp, eff.2016, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2017)
eff.2017 <- semi_join(eff.2017, tmp, by=c("Unit"="subunit", "year"))
eff.2017 <- eff.2017 %>%
  mutate(ID = as.integer(row.names(eff.2017)))
tmp.2017 <- left_join(tmp, eff.2017, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2018)
eff.2018 <- semi_join(eff.2018, tmp, by=c("Unit"="subunit", "year"))
eff.2018 <- eff.2018 %>%
  mutate(ID = as.integer(row.names(eff.2018)))
tmp.2018 <- left_join(tmp, eff.2018, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2019)
eff.2019 <- semi_join(eff.2019, tmp, by=c("Unit"="subunit", "year"))
eff.2019 <- eff.2019 %>%
  mutate(ID = as.integer(row.names(eff.2019)))
tmp.2019 <- left_join(tmp, eff.2019, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2020)
eff.2020 <- semi_join(eff.2020, tmp, by=c("Unit"="subunit", "year"))
eff.2020 <- eff.2020 %>%
  mutate(ID = as.integer(row.names(eff.2020)))
tmp.2020 <- left_join(tmp, eff.2020, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

tmp <- obs.all %>%
  filter(year==2021)
eff.2021 <- semi_join(eff.2021, tmp, by=c("Unit"="subunit", "year"))
eff.2021 <- eff.2021 %>%
  mutate(ID = as.integer(row.names(eff.2021)))
tmp.2021 <- left_join(tmp, eff.2021, by=c("subunit"="Unit", "year")) %>%
  mutate(stratum = ID) %>%
  select(year:grpsize, voc:activity)

## 2. Join back together
obs <- bind_rows(tmp.2016, tmp.2017, tmp.2018, tmp.2019, tmp.2020, tmp.2021)

eff.2016 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
eff.2017 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
eff.2018 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
eff.2019 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
eff.2020 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
eff.2021 %>%
  select(EPU = Unit, Stratum = ID) %>%
  print()
```

```{r finish obs}
# Make all numeric fields integers
obs <- obs %>%
  mutate(year = as.integer(year),
         stratum = as.integer(stratum),
         total = as.integer(total),
         cows = as.integer(cows),
         calves = as.integer(calves),
         spikes = as.integer(spikes),
         bulls = as.integer(bulls),
         unclass = as.integer(unclass),
         voc = as.integer(voc),
         grpsize = as.integer(grpsize))

# make sure totals = sum of cows, calves, etc
obs %>%
  filter(obs$total != (obs$cows+obs$calves+obs$spikes+obs$bulls+obs$unclass)) %>%
  view()
# If records show up, use code below to add unclassified individuals & re-check
obs <- obs %>%
  mutate(
    unclass = if_else(
      total == (cows+calves+spikes+bulls+unclass), unclass,
      total-((cows+calves+spikes+bulls)))
  )
obs %>%
  filter(obs$total != (obs$cows+obs$calves+obs$spikes+obs$bulls+obs$unclass)) %>%
  view() # all good now
```

```{r sampinfo 2, warning=FALSE, include=FALSE}
# Get rid of eff records of surveyed areas that had no observations

eff <- bind_rows(eff.2016, eff.2017, eff.2018, eff.2019, eff.2020, eff.2021)
eff.max <- eff %>%
  group_by(Unit) %>%
  slice_max(area_surveyed_km) %>%
  mutate(Nh = area_surveyed_km) %>%
  select(Unit, Nh)

sampinfo <- left_join(eff, eff.max, by="Unit")

sampinfo <- sampinfo %>%
  mutate(stratum = as.integer(ID), Nh = as.integer(Nh), 
         nh = as.integer(area_surveyed_km), year = as.integer(year)) %>%
  select(year, stratum, Nh, nh)

# Make sure all stratum listed in obs are listed in sampinfo for each year
setdiff(sampinfo$stratum[sampinfo$year==2016], unique(obs$stratum[obs$year==2016]))
setdiff(sampinfo$stratum[sampinfo$year==2017], unique(obs$stratum[obs$year==2017]))
setdiff(sampinfo$stratum[sampinfo$year==2018], unique(obs$stratum[obs$year==2018]))
setdiff(sampinfo$stratum[sampinfo$year==2019], unique(obs$stratum[obs$year==2019]))
setdiff(sampinfo$stratum[sampinfo$year==2020], unique(obs$stratum[obs$year==2020]))
setdiff(sampinfo$stratum[sampinfo$year==2021], unique(obs$stratum[obs$year==2021]))
```

# Analysis

## 2016

```{r 2016 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}
# 2016
# All data
est.2016 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2016), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2016))  
results.all.2016 <-print(est.2016)

# By strata
tau.hats <- matrix(NA, length(eff.2016$ID), 5)
rownames(tau.hats) <- c(eff.2016$Unit)
for(i in 1:length(eff.2016$ID)){
  tempsamp <- sampinfo[sampinfo$year==2016 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2016 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2016 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

## 2017

```{r 2017 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2017
# All data
est.2017 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2017), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2017))  
results.all.2017 <-print(est.2017)

# By strata
tau.hats <- matrix(NA, length(eff.2017$ID), 5)
rownames(tau.hats) <- c(eff.2017$Unit)
for(i in 1:length(eff.2017$ID)){
  tempsamp <- sampinfo[sampinfo$year==2017 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2017 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2017 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

## 2018

```{r 2018 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2018
# All data
est.2018 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2018), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2018))  
results.all.2018 <-print(est.2018)

# By strata
tau.hats <- matrix(NA, length(eff.2018$ID), 5)
rownames(tau.hats) <- c(eff.2018$Unit)
for(i in 1:length(eff.2018$ID)){
  tempsamp <- sampinfo[sampinfo$year==2018 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2018 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2018 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

## 2019

```{r 2019 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2019
# Keep in mind had to remove observations b/c lost effort data for Mar 29
# All data
est.2019 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2019), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2019))  
results.all.2019 <-print(est.2019)

# By strata
tau.hats <- matrix(NA, length(eff.2019$ID), 5)
rownames(tau.hats) <- c(eff.2019$Unit)
for(i in 1:length(eff.2019$ID)){
  tempsamp <- sampinfo[sampinfo$year==2019 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2019 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2019 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

## 2020

```{r 2020 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2020
# All data
est.2020 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2020), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2020))  
results.all.2020 <-print(est.2020)

# By strata
tau.hats <- matrix(NA, length(eff.2020$ID), 5)
rownames(tau.hats) <- c(eff.2020$Unit)
for(i in 1:length(eff.2020$ID)){
  tempsamp <- sampinfo[sampinfo$year==2020 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2020 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2020 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

## 2021

```{r 2021 analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2021
# All data
est.2021 <- Sight.Est(observed ~ 1, odat = subset(obs,year == 2021), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2021))  
results.all.2021 <-print(est.2021)

# By strata
tau.hats <- matrix(NA, length(eff.2021$ID), 5)
rownames(tau.hats) <- c(eff.2021$Unit)
for(i in 1:length(eff.2021$ID)){
  tempsamp <- sampinfo[sampinfo$year==2021 & sampinfo$stratum==i, ]
  tempobs <- obs[obs$year == 2021 & obs$stratum == i, ]
  temp <- Sight.Est(observed ~ 1, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2021 <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

### With VOC variable:

```{r 2021 voc analysis, echo=TRUE, warning=FALSE, paged.print=TRUE}

# 2021 w/ voc (remove any NAs in voc)
obs.voc <- obs %>%
  filter(!is.na(voc))
# All data
est.2021.voc <- Sight.Est(observed ~ voc, odat = subset(obs.voc,year == 2021), sdat = exp1,
  sampinfo = subset(sampinfo, year == 2021))  
results.all.2021.voc <-print(est.2021.voc)

# By strata
tau.hats <- matrix(NA, length(eff.2021$ID), 5)
rownames(tau.hats) <- c(eff.2021$Unit)
for(i in 1:length(eff.2021$ID)){
  tempsamp <- sampinfo[sampinfo$year==2021 & sampinfo$stratum==i, ]
  tempobs <- obs.voc[obs.voc$year == 2021 & obs.voc$stratum == i, ]
  temp <- Sight.Est(observed ~ voc, odat = tempobs, sdat = exp1, tempsamp)
  tau.hats[i, ] <- temp$est
}
colnames(tau.hats) <- names(temp$est)
tau.hats<-round(tau.hats, 0)
results.strat.2021.voc <- print(format(tau.hats, big.mark = ","), justify = "left", quote = FALSE)
```

